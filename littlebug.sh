#!/bin/bash
export lang=ja_jp.utf-8

: "çµ‚äº†æ™‚ã‚¯ãƒªãƒ³ãƒŠãƒƒãƒ—" && {
	# ä½œæ¥­ç”¨ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¾Œå§‹æœ«ç”¨é–¢æ•°ã¨ãƒˆãƒ©ãƒƒãƒ—è¨­å®š
	function cleanup_tmpdir() {
		:
	}
	trap cleanup_tmpdir INT
	trap cleanup_tmpdir EXIT
}

: â€åˆæœŸãƒã‚§ãƒƒã‚¯â€ && {
	#GUN AwkãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
	if [[ $(gawk --virsion > /dev/null 2>&1 ) =~ 'GNU Awk' ]] ; then
			echo "è­¦å‘Š: gunç‰ˆawk ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚gunç‰ˆawk ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚" >&2
			return 1
	fi

	declare tgtFile="$(basename "${1}")"   #å¼•æ•°ã§æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã¨ã™ã‚‹
	if [[ "${tgtFile/ /}" = '' ]];then
		echo "ğŸ’©å¤‰æ›å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
		exit 1
	fi

	if [[ ! -e "${tgtFile}" ]]; then
		echo "ğŸ’© ${tgtFile}ãªã‚“ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã„ãªã„ã§ã™"
		exit 1
	fi

	convMode="${2}"  #'-t2h'ã§txtâ†’htmlã€'-h2t'ã§htmlâ†’txtã€ãã‚Œä»¥å¤–ã¯ä»Šã®æ‰€ã¯ã‚¨ãƒ©ãƒ¼

	if [[ "${convMode}" != '' ]] && [[ "${convMode}" != '-t' ]] ; then
		echo "ğŸ’© å¼•æ•°1ã¯ã€ç„¡ã—(txtâ†’html)ã‹ã€-t(htmlâ†’txt)ã§æŒ‡å®šã—ã¦ãã ã•ã„"
		exit 1
	fi
}

: "åˆæœŸå‡¦ç†" && {
	# æ–‡å­—ã‚³ãƒ¼ãƒ‰ç¢ºèªãƒ»å¤‰æ›ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å®šç¾©
	chrset="$(file -i ${tgtFile})"

	SCRIPT_DIR=$(cd $(dirname $0); pwd)

	# å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã€unknown-8bit(SJIS)ãªã‚‰UTF-8ã«å¤‰æ›ã™ã‚‹
	if [[ "${chrset##*charset=}" != 'utf-8' ]] ; then
		echo 'å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®charset(æ–‡å­—ã‚³ãƒ¼ãƒ‰)ãŒUTF-8ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã¯ç¶šè¡Œã—ã¾ã™ãŒã€å¤‰æ›çµæœã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚'
		echo 'â€»  ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æ—¥æœ¬èªæ–‡å­—ãŒä¸€ã¤ã‚‚å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€æ­£ã—ãUTF-8ã§ã‚ã£ã¦ã‚‚ã“ã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'
	fi
}

if [[ "${convMode}" = '' ]]; then
	## txtâ†’html ############################################################################################
	: "txtâ†’htmlå¤‰æ›å‡¦ç†" && {
		: "AWKã‚³ãƒ¼ãƒ‰å®šç¾©" && {
			# littlebug.awkã®å†…å®¹ã‚’ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å®šç¾©
			read -r -d '' AWK_CODE <<- 'AWK_EOF'
			#!/usr/bin/awk -f

			# ãƒ«ãƒ“ã‚¿ã‚°ã«ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦ç½®æ›ã™ã‚‹é–¢æ•°
			# gawkæ‹¡å¼µã®match()ç¬¬ä¸‰å¼•æ•°ã‚’ä½¿ç”¨
			function apply_ruby_classes(text) {
					new_text = ""
					# ãƒ†ã‚­ã‚¹ãƒˆå†…ã«ãƒ«ãƒ“ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãªããªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
					while (match(text, /ï½œ([^ã€Š]+)ã€Š([^ã€‹]+)ã€‹/, m)) {
							# ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã‚ˆã‚Šå‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
							new_text = new_text substr(text, 1, RSTART - 1)

							parent = m[1]
							ruby = m[2]

							# ã‚¯ãƒ©ã‚¹ã®æ±ºå®š
							class = ""
							if (length(parent) == length(ruby)) {
									class = "ltlbg_ruby-mono"
							} else if (length(ruby) == 2 * length(parent)) {
									class = "ltlbg_ruby-same"
							} else if (length(ruby) > 2 * length(parent)) {
									class = "ltlbg_ruby-long"
							} else {
									class = "ltlbg_ruby-short"
							}

							# ç½®æ›å¾Œã®HTMLã‚’ç”Ÿæˆ
							replacement = "<ruby class=\"" class "\" data-" class "=\"" ruby "\">" parent "<rt>" ruby "</rt></ruby>"
							# æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã«ç½®æ›éƒ¨åˆ†ã‚’è¿½åŠ 
							new_text = new_text replacement

							# æœªå‡¦ç†ã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’æ›´æ–°
							text = substr(text, RSTART + RLENGTH)
					}
					# æ®‹ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’è¿½åŠ 
					new_text = new_text text
					return new_text
			}

			# åœç‚¹ï¼ˆå‚ç‚¹ï¼‰ã‚’æ–‡å­—ã”ã¨ã®ãƒ«ãƒ“ã«å¤‰æ›ã™ã‚‹é–¢æ•°
			function apply_emphasis_dots(text) {
					new_text = ""
					# ã€Šã€Š...ã€‹ã€‹ ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãªããªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
					while (match(text, /ã€Šã€Š([^ã€‹]+)ã€‹ã€‹/, m)) {
							# ãƒãƒƒãƒéƒ¨åˆ†ã‚ˆã‚Šå‰ã‚’ new_text ã«è¿½åŠ 
							new_text = new_text substr(text, 1, RSTART - 1)

							parent_text = m[1]
							
							replacement = ""
							
							# è¦ªæ–‡å­—ã‚’1æ–‡å­—ãšã¤ãƒ«ãƒ¼ãƒ—
							for (i = 1; i <= length(parent_text); i++) {
									char = substr(parent_text, i, 1)
									replacement = replacement "<ruby class=\"emphasis\">" char "<rt>ï¹…</rt></ruby>"
							}
							
							new_text = new_text replacement
							
							text = substr(text, RSTART + RLENGTH)
					}
					new_text = new_text text
					return new_text
			}

			BEGIN {
				state_p = "none"     # none, discript, bracket
				state_section = "none"     # none, section
				in_quote = 0       # 1 = ã€Œã€ã®å†…éƒ¨ã‚’å‡¦ç†ä¸­
				output_buffer = ""   # å‡ºåŠ›ãƒãƒƒãƒ•ã‚¡
			}

			{
				#############################################################################
				## åˆæœŸå‡¦ç†ã€è¡Œå…¨ä½“çš„ãªå‡¦ç†
				#############################################################################
				#ç©ºè¡Œã¯å‡ºåŠ›ã—ãªã„
				if ($0 ~ /^$/) { next; }

				#ç½®æ›å¾Œãƒ»å‡ºåŠ›ç”¨ã®æ–‡è¨€ã‚’å‰µå‡ºã—ã¤ã¤
				#åˆ¤å®šè‡ªä½“ã¯å…ƒã®è¡Œã®å½¢ã‚’ç”¨ã„ã‚‹ãŸã‚ã€$0ã¨lineã‚’åˆ¥ã«è¨­ã‘ã‚‹
				line = $0

				###########################################################
				# å‡¦ç†ä¸­ã«å•é¡Œã«ãªã‚‹ç‰¹æ®Šæ–‡å­—ã®ä¸€æ¬¡ç½®æ›(æœ€å¾Œã«å…ƒã«æˆ»ã™)
				# htmlã‚’æ„è­˜ã—ã¦æ—¢ã«æ–‡å­—å‚ç…§å‹ã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚‚å«ã‚€
				# å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
				line = gensub(/ã€€/, "ã€¼", "g", line);
				# åŠè§’ã‚¹ãƒšãƒ¼ã‚¹
				line = gensub(/ /, "ã€¿", "g", line);
				# ã‚¹ãƒ©ãƒƒã‚·ãƒ¥
				line = gensub(/&#047;|\//, "ï¼†ï¼ƒï¼ï¼”ï¼—", "g", line);
				# ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥
				line = gensub(/&#092;|\\/, "ï¼†ï¼ƒï¼ï¼™ï¼’", "g", line);
				# åŠè§’ã®>
				line = gensub(/&gt;|>/, "ï¼†ï½‡ï½”", "g", line);
				#åŠè§’ã®<
				line = gensub(/&lt;|</, "ï¼†ï½Œï½”", "g", line);
				# ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
				line = gensub(/&#39;|'/, "ï¼†ï¼ƒï¼“ï¼™", "g", line);
				# ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
				line = gensub(/&#quot;|\\"/, "ï¼†ï½‘ï½•ï½ï½”", "g", line);
				# æ®‹ã£ãŸã‚¢ãƒ³ãƒ‘ã‚µãƒ³ãƒ‰
				line = gensub(/&amp;|&/, "ï¼†ï½ï½ï½", "g", line);

				#ã‚´ãƒŸã‚¹ãƒšãƒ¼ã‚¹ã‚’æƒé™¤
				line = gensub(/[ã€¿ã€¼]$/, "", "g", line);
				line = gensub(/[ã€¿ã€¼]([ã€ã€ï¼‰ã€Ÿ])/, "\\1", "g", line);

				#è¨˜å·ç¨®é¡ã®çµ±ä¸€
				line = gensub(/[â™¡â™¥]/, "â¤", "g", line);
				line = gensub(/â˜†/, "â˜…", "g", line);
				line = gensub(/â–¡/, "â– ", "g", line);
				line = gensub(/[â™«â™¬]/, "â™ª", "g", line);
				line = gensub(/â€•+/, "â€•", "g", line);
				line = gensub(/ï¼ï¼/, "!!", "g", line);
				line = gensub(/ï¼ï¼Ÿ/, "!?", "g", line);
				line = gensub(/ï¼Ÿï¼/, "?!", "g", line);
				line = gensub(/ï¼Ÿï¼Ÿ/, "??", "g", line);
				line = gensub(/^(Â§+)[ã€¿ã€¼]/, "\\1", "g", line);
				
				# é€£ç¶šã™ã‚‹æ„Ÿå˜†ç¬¦ãƒ»ç–‘å•ç¬¦ãƒ»è¨˜å·é¡ã®å¾Œã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒ¿å…¥ã—ã€
				# ãã‚Œã‚’<span class="ltlbg_wSp"></span>ã«ç½®æ›
				# å¯¾è±¡ ï¼!?ï¼Ÿâ¤ğŸ’ğŸ’•â™ªâ˜†â˜…ğŸ’¢
				line = gensub(/([!\?ï¼ï¼Ÿâ¤ğŸ’ğŸ’•â™ªâ˜†â˜…ğŸ’¢])([^ã€¼ã€ã€ï¼‰!\?ï¼ï¼Ÿâ¤ğŸ’ğŸ’•â™ªâ˜†â˜…ğŸ’¢])/, "\\1<span class=\"ltlbg_wSp\"></span>\\2", "g", line);

				#ä¸Šè¨˜ç‰¹æ®Šè¨˜å·(â¤,â˜…,â– ,â™ª,!!,!?,?!,??)ã‚’ã€<span class="ltlbg_wdfix"></span>ã‚¿ã‚°ã§æ‹¬ã‚‹
				line = gensub(/([â¤â˜…â– â™ª])/, "<span class=\"ltlbg_wdfix\">\\1</span>", "g", line);
				line = gensub(/!!/, "<span class=\"ltlbg_wdfix\">!!</span>", "g", line);
				line = gensub(/!\?/, "<span class=\"ltlbg_wdfix\">!?</span>", "g", line);
				line = gensub(/\?!/, "<span class=\"ltlbg_wdfix\">?!</span>", "g", line);
				line = gensub(/\?\?/, "<span class=\"ltlbg_wdfix\">??</span>", "g", line);

				#############################################################################
				## æ®µè½ç³»å‡¦ç†
				#############################################################################

				# section(ä¸­æ®µè½)###########################################################
				#è¡Œé ­ã«Â§ãŒç™»å ´ã™ã‚‹å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚¿ã‚°ã‚’ä»˜ä¸ã—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’é–‹å§‹ã™ã‚‹ã€‚
				if ($0 ~ /^Â§+/) {

					#åˆå›ã®å ´åˆã€pã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã¯é–‹å§‹ã•ã‚Œã¦ã„ãªã„ã®ã§é–‰ã˜ãªã„
					#åˆå›ä»¥å¤–ã§ã¯ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¢ƒç•Œã§pã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¿…ãšé–‰ã˜ã‚‹
					if (state_p != "none") {
							output_buffer = output_buffer "  </div>" ORS
							state_p = "none"
					}
					#åˆå›ã®å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹(ã‚»ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’é–‹å§‹ã™ã‚‹)
					#åˆå›ä»¥å¤–ã§ã¯ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã¦ã‹ã‚‰é–‹ãç›´ã™
					if (state_section != "none") {
						output_buffer = output_buffer "</section>" ORS
					}

					# sectionã‚¯ãƒ©ã‚¹ã‚’æ±ºå®šã™ã‚‹
					section_class = "ltlbg_section"
					if ($0 ~ /^Â§+â¤/) {
						section_class = "ltlbg_section_sukebe"
						# â¤ã‚’é™¤å»
						sub(/â¤/, "", line)
					}

					output_buffer = output_buffer "<section class=\"" section_class "\">" ORS
					state_section = "section"

					# Â§ã®è¡Œè‡ªä½“ã«ã‚‚ãƒ«ãƒ“ãªã©ã®ç½®æ›ã‚’é©ç”¨ã—ãŸã„å ´åˆã¯ã“ã“ã«è¨˜è¿°
					line = apply_ruby_classes(line)
					line = apply_emphasis_dots(line)
					
					line = gensub(/(Â§+.*)/, "  <h2 class=\"ltlbg_section_name\">\\1</h2>", "g", line);

					output_buffer = output_buffer line ORS
					next
				}

				# div(ä¸­æ®µè½)  ################################################################
				# å½“å½¢å¼ã§ã¯ã€Œåœ°ã®æ–‡ã®å¡Šã€ã¨ã€Œã‚»ãƒªãƒ•ã®å¡Šã€ã‚’åˆ†ã‘ã¦ç®¡ç†ã—ã€ãã®å¡Šã‚’æ„å‘³æ®µè½ã®ä¸€ç¨®ã¨ã—ã¦divã§æ‹¬ã‚‹ã€‚
				# åœ°ã®æ–‡ã®å¡Šâ€¦â€¦discript-groupã‚¯ãƒ©ã‚¹
				# ã‚»ãƒªãƒ•ã®å¡Šâ€¦â€¦bracket-groupã‚¯ãƒ©ã‚¹
				# ã“ã®æ„å‘³æ®µè½ã‚’ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã©ã†è½ã¨ã—è¾¼ã‚€ã‹(ä¾‹ãˆã°åœ°ã®æ–‡ã¨ã‚»ãƒªãƒ•ã®é–“ã«ã¯ç©ºè¡Œã‚’æŒŸã‚€å½¢å¼ãªã©)ã¯ã€ã‚¹ã‚¿ã‚¤ãƒ«(css)ã«ã‚ˆã£ã¦æ±ºå®šã™ã‚‹ã€‚

				# ç¾åœ¨ã®è¡Œã«é–‹ãæ‹¬å¼§é¡ãŒå«ã¾ã‚Œã‚‹ã‹ï¼ˆé–‹å§‹åˆ¤å®šï¼‰
				# å«ã¾ã‚Œã¦ã„ã‚Œã°ã€ä»¥é™ã‚’ã‚¯ã‚ªãƒ¼ãƒˆçŠ¶æ…‹ã¨ã—ã€æ¬¡ã«è¡Œæœ«é–‰ã˜æ‹¬å¼§é¡ãŒç¾ã‚Œã‚‹ã¾ã§ã‚¯ã‚ªãƒ¼ãƒˆä¸­ã‚’ç¶­æŒã™ã‚‹
				if ($0 ~ /^[ã€Œã€ï¼ˆ]/) { in_quote = 1}

				# åˆ¤å®šï¼šç¾åœ¨ã€ã‚¯ã‚ªãƒ¼ãƒˆçŠ¶æ…‹ãŒç¶™ç¶šä¸­ã§ã‚ã‚‹ã‹ã€ã‚‚ã—ãã¯è¡Œé ­é–‹ãæ‹¬å¼§é¡ã‹
				# ã‚‚ã—ãã†ã§ã‚ã‚Œã°ã€pã‚¿ã‚°ã®ã‚¯ãƒ©ã‚¹ã‚’bracketã«ã™ã‚‹ã€‚
				# ã“ã‚Œã«è©²å½“ã—ãªã„å ´åˆã¯ã‚¯ãƒ©ã‚¹ã¯discriptã¨ãªã‚‹
				if ( in_quote == 1 || $0 ~ /^[ã€Œã€ï¼ˆ]/) {
					current_type = "ltlng_bracket-group"
				} else {
					current_type = "ltlng_discript-group"
				}

				# çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸï¼ˆã¾ãŸã¯æœ€åˆã®è¡Œï¼‰å ´åˆã®ã‚¿ã‚°æŒ¿å…¥
				if (state_p != current_type) {
					if (state_p != "none") { output_buffer = output_buffer "  </div>" ORS }
					output_buffer = output_buffer "  <div class=\"" current_type "\">" ORS
					state_p = current_type
				}
				
				# p(å°æ®µè½)###########################################################
				# è¡Œé ­ãŒå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã®è¡Œã¯ã€Œåœ°ã®æ–‡ã®å½¢å¼æ®µè½ã€ã¨ã™ã‚‹ã€‚
				# è¡Œé ­ãŒé–‹ãæ‹¬å¼§é¡ã®è¡Œã¯ã‚»ãƒªãƒ•ã ãŒã€ã‚»ãƒªãƒ•ã®è¡Œã‚‚å½¢å¼æ®µè½ã¨ã—ã¦æ‰±ã†ã€‚
				# å½“å½¢å¼ã§ã¯ã€ã‚»ãƒªãƒ•å†…ã«æ›´ã«å½¢å¼æ®µè½ã‚’å«ã‚€ã“ã¨ã‚’è¨±å®¹ã™ã‚‹ã€‚
				# ã‚»ãƒªãƒ•å†…å½¢å¼æ®µè½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ã‚»ãƒªãƒ•æ®µè½ã¯ä»¥ä¸‹ã®ï¼”ã¤ã«åˆ†é¡ã™ã‚‹ã€‚
				# ï¼‘ï¼é–‹ãæ‹¬å¼§ã¨é–‰ã˜æ‹¬å¼§ã®ä¸¡æ–¹ã‚’å«ã‚€è¡Œ(ä¸€èˆ¬çš„ãªã‚»ãƒªãƒ•è¡Œ)
				# ï¼’ï¼é–‹ãæ‹¬å¼§ã®ã¿(ã‚»ãƒªãƒ•å†…å½¢å¼æ®µè½ã«ã¤ãªãŒã‚‹è¡Œ)
				# ï¼“ï¼é–‰ã˜æ‹¬å¼§ã®ã¿ (ã‚»ãƒªãƒ•å†…å½¢å¼æ®µè½ã‹ã‚‰æˆ»ã‚‹è¡Œ)
				# ï¼”ï¼å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã§å§‹ã¾ã‚‹è¡Œ(åœ°ã®æ–‡å½¢å¼æ®µè½ã¨åŒã˜æ‰±ã„ã€‚ã‚»ãƒªãƒ•å†…ã§ã‚ã‚‹ã‹å¦ã‹ã‚’å•ã‚ãªã„)
				# ãã‚Œãã‚Œã«å¯¾å¿œã™ã‚‹pã‚¿ã‚°ã‚’ç”Ÿæˆã™ã‚‹ã€‚
				line = gensub(/^([ã€Œã€ï¼ˆ])([^ã€ã€ï¼‰]+)([ã€ã€ï¼‰])$/, "    <p class=\"ltlbg_bracket\" data-p_header=\"\\1\" data-p_footer=\"\\3\">\\2</p><!--bracket-->", "g", line); #ä¸¡æ–¹
				line = gensub(/^([ã€Œã€ï¼ˆ])([^ã€ã€ï¼‰]+)$/, "    <p class=\"ltlbg_bracket\" data-p_header=\"\\1\" data-p_footer=\"\">\\2</p><!--bracket-->", "g", line); #é–‹æ‹¬å¼§ã®ã¿
				line = gensub(/^([^ã€Œã€ï¼ˆ]+)([ã€ã€ï¼‰])$/, "    <p class=\"ltlbg_bracket\" data-p_footer=\"\\2\">\\1</p><!--bracket-->", "g", line); #é–‰ã˜æ‹¬å¼§ã®ã¿
				line = gensub(/^ã€¼(.+)$/, "    <p class=\"ltlbg_desciption\" data-p_header=\"ã€¼\">\\1</p><!--descript-->", "g", line); #åœ°ã®æ–‡(æ‹¬å¼§é¡ã‚°ãƒ«ãƒ¼ãƒ—ã®å†…éƒ¨å«ã‚€)

				#############################################################################
				## é€šå¸¸ã®å¤‰æ›
				#############################################################################
				# å¥èª­ç‚¹ãƒ»è¨˜å·é¡ã®spanã‚¿ã‚°åŒ–###########################################################  
				#ã‚¿ã‚°ã§æ‹¬ã‚‹ã‚¿ã‚¤ãƒ—ã®ä¿®é£¾
				line = gensub("([^\"])ã€¼([^\"])", "\\1<span class=\"ltlbg_wSp\"></span>\\2", "g", line); # å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
				line = gensub(/â€•/, "<span class=\"ltlbg_wSize\">â€•</span>", "g", line); #å…¨è§’ãƒ€ãƒƒã‚·ãƒ¥ã¯å¸¸ã«ãƒ¯ã‚¤ãƒ‰ã‚¿ã‚°ã‚’é©ç”¨
				line = gensub(/\[-([^-]+)-\]/, "<span class=\"ltlbg_wdfix\">\\1</span>", "g", line); #å¼·åˆ¶1æ–‡å­—å¹…ã‚¿ã‚°
				line = gensub(/\*\*([^\*]+)\*\*/, "<span class=\"ltlbg_bold\">\\1</span>", "g", line); #å¤ªå­—
				line = gensub(/\[\^(.+)\^\]/, "<span class=\"ltlbg_rotate\">\\1</span>", "g", line); #å›è»¢ã‚¿ã‚°
				line = gensub(/\^(.+)\^/,"<span class=\"ltlbg_tcy\">\\1</span>", "g",line) #ç¸¦ä¸­æ¨ª
				line = gensub(/\[l\[(.+)\]r\]/, "<span class=\"ltlbg_forcedGouji1/2\">\\1</span>", "g", line); #å¼·åˆ¶åˆå­—1/2ã‚¿ã‚°
				line = gensub(/[ï¼›;]/, "<span class=\"ltlbg_semicolon\">ï¼›</span>", "g", line); #åŠè§’ã‚»ãƒŸã‚³ãƒ­ãƒ³ã¯å…¨ã¦å…¨è§’ã«ä¿®æ­£
				line = gensub(/[ï¼š:]/, "<span class=\"ltlbg_colon\">ï¼š</span>", "g", line); #åŠè§’ã‚³ãƒ­ãƒ³ã¯å…¨ã¦å…¨è§’ã«ä¿®æ­£
				line = gensub(/\[-[^-]{1,2}-\]/, "<span class=\"ltlbg_wdfix\">\\1</span>", "g", line); #1æ–‡å­—å¹…åŒ–
				
				# ã‚¿ã‚°ã«ç½®æ›ã™ã‚‹ã‚¿ã‚¤ãƒ—ã®å¤‰æ›
				# ã‚¿ã‚°ã‚’æŒ¿å…¥ã™ã‚‹ã ã‘ã§ã€æ”¹ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã¯ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚ˆã‚‹
				line = gensub(/ã‚›/, "<span class=\"ltlbg_dakuten\"></span>", "g", line); #ã‚¹ã‚±ãƒ™æ¿éŸ³
				line = gensub(/ã‚œ/, "<span class=\"ltlbg_handakuten\"></span>", "g", line); #ã‚­ãƒã‚¬ã‚¤åŠæ¿éŸ³
				line = gensub(/\[newpage\]/, "<div class=\"ltlbg_newpage\"></div><!--ltlbg_newpage-->", "g", line); # æ”¹ãƒšãƒ¼ã‚¸
				line = gensub(/---/, "<span class=\"ltlbg_hr\"></span>", "g", line); # æ°´å¹³ç·š
				line = gensub(/ï¼ï¼¼|ã€±/, "<span class=\"ltlbg_odori1\"></span><span class=\"ltlbg_odori2\"></span>", "g", line); #è¸Šã‚Šå­—ã€‚
				
				###########################################################
				# ãƒ«ãƒ“ãƒ»åœç‚¹â€¦â€¦ä¸Šéƒ¨ã®é–¢æ•°ã§å®Ÿè£…
				###########################################################
				line = apply_ruby_classes(line)
				line = apply_emphasis_dots(line)

				
				#############################################################################
				## è¡Œæœ«å‡¦ç†
				#############################################################################
				## ç‰¹æ®Šæ–‡å­—ã®å¾©æ—§
				line = gensub(/ï¼†ï½ï½ï½/, "\\&amp;", "g", line);
				line = gensub(/ï¼†ï½Œï½”/, "\\&lt;", "g", line);
				line = gensub(/ï¼†ï½‡ï½”/, "\\&gt;", "g", line);
				line = gensub(/ï¼†ï¼ƒï¼“ï¼™/, "\\&#39;", "g", line);
				line = gensub(/ï¼†ï½‘ï½•ï½ï½”/, "\\&quot;", "g", line);
				line = gensub(/ï¼†ï¼ƒï¼ï¼”ï¼—/, "\\&#047;", "g", line);
				line = gensub(/ï¼†ï¼ƒï¼ï¼™ï¼’/, "\\&#092;", "g", line);

				#å¿…è¦ãŒã‚ã£ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã«ä»£ã‚ã‚Šã«ä½¿ç”¨ã—ã¦ã„ãŸä»¥ä¸‹ã®ç‰¹æ®Šæ–‡å­—ã‚’å…ƒã«æˆ»ã™
				line = gensub("ã€¿", "<span class="ltlbg_sSp"></span>", "g", line);
				line = gensub("ã€¼", "<span class="ltlbg_wSp"></span>", "g", line);

				# è¡Œæœ« ãŒã€ ã‹ã©ã†ã‹ï¼ˆçµ‚äº†åˆ¤å®šï¼‰
				# è¡Œæœ«ãŒã€ã§ã‚ã‚Œã°ã€ç¾åœ¨ç¶™ç¶šä¸­ã®ã‚¯ã‚ªãƒ¼ãƒˆçŠ¶æ…‹ã‚’è§£é™¤ã™ã‚‹ã€‚
				if ($0 ~ /[ã€ã€ï¼‰]$/) { in_quote = 0 }

				# è¡Œã®å‡ºåŠ›ï¼ˆãƒ¡ãƒ¢ãƒªã«æºœã‚è¾¼ã‚€ï¼‰
				output_buffer = output_buffer line ORS

			}

			END {
				#ä¸€åº¦ã‚‚pã‚¿ã‚°ãŒç™»å ´ã—ã¦ã„ãªã„å ´åˆã€é–‰ã˜ã‚‹å¿…è¦ãŒãªã„(ã»ã¼ã‚ã‚Šå¾—ãªã„ãŒ)
				if (state_p != "none") { output_buffer = output_buffer "  </div>" ORS }

				#ä¸€åº¦ã‚‚sectionã‚¿ã‚°ãŒç™»å ´ã—ã¦ã„ãªã„å ´åˆã€é–‰ã˜ã‚‹å¿…è¦ãŒãªã„(å‰²ã¨ã‚ã‚Šå¾—ã‚‹)
				if (state_section != "none") { output_buffer = output_buffer "</section>" ORS }

				##########################################################################################
				# htmlã«ãªã‚‹ã‚ˆã†ã«å…ˆé ­ã¨æœ«å°¾ã«å¿…è¦ãªã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚‹ã€‚
				# ã¾ãŸlittlebugXXX.cssèª­ã¿è¾¼ã‚€ã‚ˆã†è¿½è¨˜ã™ã‚‹
				##########################################################################################
				header =        "<html>" ORS
				header = header "  <head>" ORS
				header = header "    <link rel=\"stylesheet\" href=\"../css/littlebugI.css\">" ORS
				header = header "    <!--<link rel=\"stylesheet\" href=\"../css/littlebugV.css\">-->" ORS
				header = header "    <link rel=\"stylesheet\" href=\"../css/littlebugH.css\">" ORS
				header = header "    <link rel=\"stylesheet\" href=\"../css/littlebugU.css\">" ORS
				header = header "  </head>" ORS
				header = header "  <body>" ORS
				header = header "<div class=\"ltlbg_container\">" ORS
				header = header "<!--æ–‡ç« å†…å®¹ã“ã“ã‹ã‚‰-->" ORS

				footer =        "<!--æ–‡ç« å†…å®¹ã“ã“ã¾ã§-->" ORS
				footer = footer "</div><!--ltlbg_container-->" ORS
				footer = footer "</body>" ORS
				footer = footer "</html>" ORS

				# ãƒ¡ãƒ¢ãƒªã«æºœã‚è¾¼ã‚“ã å…¨ã¦ã®å‡ºåŠ›ã‚’ä¸€åº¦ã«å‡ºåŠ›
				printf "%s", header output_buffer footer
			}
			AWK_EOF
		}

		destFile="${tgtFile/'.txt'/'_tagged.html'}" #å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã™ã‚‹
		printf '' > "${destFile}"

		: "è­¦å‘Šè¡¨ç¤º" && {
			##è­¦å‘Šè¡¨ç¤º####################################################################
			# å¤‰æ›ä¸èƒ½ãªã‚±ãƒ¼ã‚¹ã‚’äºˆã‚æŠ½å‡ºã™ã‚‹ã€‚
			# å‡¦ç†ã¯ä¸­æ–­ã›ãšæœ€å¾Œã¾ã§è¡Œã†ãŒã€è­¦å‘Šè¡¨ç¤ºã‚’è¡Œã†ã€‚
			# ãŠãã‚‰ãå¤‰æ›å‡¦ç†ã¯æˆåŠŸã—ãªã„ã€‚
			##############################################################################
			# ã‚¿ãƒ–æ–‡å­—ãŒå­˜åœ¨ã™ã‚‹
			grep -E -o -n '\t' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã‚¿ãƒ–æ–‡å­—ãŒå­˜åœ¨ã—ã¾ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# è¡Œé ­ã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹2ã¤ä»¥ä¸Šã®ç©ºç™½æ–‡å­—
			grep -E -o -n '^[ ã€€]{2,}' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘è¡Œé ­ã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹2ã¤ä»¥ä¸Šã®ç©ºç™½æ–‡å­—ãŒã‚ã‚Šã¾ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ãƒ«ãƒ“æŒ‡å®šã«å‚ç‚¹ã®åŒæ™‚æŒ‡å®š
			# ï½œã€Šã€‹ã®å…¨ä½“ã‹æ¯å­—éƒ¨åˆ†ã‹ã®ã©ã¡ã‚‰ã‹ã«ã€ã€Šã€Šã€‹ã€‹æŒ‡å®šãŒå…¥ã‚Œå­ã•ã‚Œã¦ã„ã‚‹â€»ãƒ«ãƒ“æ–‡å­—éƒ¨åˆ†ã¸ã®ç‰¹æ®ŠæŒ‡å®šã¯å¾Œç¶šã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹
			grep -E -o -n 'ï½œ[^ã€Š]*ã€Šã€Š[^ã€‹]+ã€‹ã€‹ã€Š[^ã€‹]+ã€‹|ã€Šã€Š[^ï½œ]*ï½œ[^ã€Š]+ã€Š[^ã€‹]+ã€‹[^ã€‹]*ã€‹ã€‹' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ãƒ«ãƒ“ã¨å‚ç‚¹ãŒåŒæ™‚ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			#2æ–‡å­—ä»¥ä¸Šã«å›è»¢æŒ‡å®š
			grep -E -o -n '\[\^[^\^]{2,}\^\]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§2æ–‡å­—ä»¥ä¸Šã®ç¯„å›²ã«å›è»¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			#ãƒ«ãƒ“å…¨ä½“ã¸ã®å›è»¢æŒ‡å®šâ€»æ¯å­—ã®ã¿ã‚ã‚‹ã„ã¯ãƒ«ãƒ“æ–‡å­—ã®ã¿ã¯è¨±å®¹ã™ã‚‹
			grep -E -o -n '\[\^[^ï½œ]*ï½œ[^ã€Š]*ã€Šã€Š[^ã€‹]+ã€‹ã€‹[^\^]*\^\]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ãƒ«ãƒ“ã¨å›è»¢ãŒåŒæ™‚ã«æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			#ãƒ«ãƒ“æŒ‡å®šå…¨ä½“ã¸ã®ç¸¦ä¸­æ¨ªâ€»æ¯å­—ã®ã¿ã‚ã‚‹ã„ã¯ãƒ«ãƒ“æ–‡å­—ã®ã¿ã¯è¨±å®¹ã™ã‚‹
			grep -E -o -n '\^[^ï½œ]*ï½œ[^ã€Š]*ã€Šã€Š[^ã€‹]+ã€‹ã€‹[^\^]*\^' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ãƒ«ãƒ“æŒ‡å®šå…¨ä½“ã¸ã®ç¸¦ä¸­æ¨ªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ç¸¦ä¸­æ¨ªã®ä¸­ã«åŠè§’è‹±æ•°è¨˜å·ä»¥å¤–(æ–‡å­—ã‚³ãƒ¼ãƒ‰ä¸Šã€ŒåŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã€ã€œã€Œ~ã€ã®é ˜åŸŸ)ãŒå«ã¾ã‚Œã¦ã„ã‚‹
			# ãŸã ã—ã€ç¸¦ä¸­æ¨ªå…¨ä½“ã¸ã®å¤ªå­—ã¨å‚ç‚¹ã¯ã¯è¨±å®¹ã™ã‚‹ãŸã‚ã€ã€Šã€‹*ã‚‚ã“ã‚Œã‚‰ã«å«ã‚ãªã„ã€‚
			grep -E -o -n '\^[^\^]*[^ -~ã€Šã€‹]+[^\^]*\^' "${tgtFile}" >"${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ç¸¦ä¸­æ¨ªã®ä¸­ã«åŠè§’è‹±æ•°æ–‡å­—ä»¥å¤–ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ç¸¦ä¸­æ¨ªæŒ‡å®šã®ä¸€éƒ¨ã«å¤ªå­—æŒ‡å®š
			# ç¸¦ä¸­æ¨ªæŒ‡å®š^æ–‡å­—^ã®ä¸­ã«ã€**ã¨**ã§æ‹¬ã‚‰ã‚Œã¦ã„ãªã„æ–‡å­—ãŒ1æ–‡å­—ä»¥ä¸Šã‚ã‚‹
			grep -E -o -n '\^[^\*]+\*\*[^\*]+\*\*\^|\^\*\*[^\*]+\*\*[^\*]+\^' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ç¸¦ä¸­æ¨ªã®ä¸€éƒ¨ã«ã ã‘å¤ªå­—ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›çµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# 4æ–‡å­—ä»¥ä¸Šã®ç¸¦ä¸­æ¨ª()
			# ãŸã ã—ã€ç¸¦ä¸­æ¨ªå…¨ä½“ã¸ã®å¤ªå­—ã¨å‚ç‚¹ã¯ã¯è¨±å®¹ã™ã‚‹ãŸã‚ã€ã€Šã€‹*ã‚‚ã“ã‚Œã‚‰ã«å«ã‚ãªã„ã€‚
			grep -E -o -n '\^(\*\*)*[^\*ã€Šã€‹]{4,}(\*\*)*\^' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§4æ¡ä»¥ä¸Šã®ç¸¦ä¸­æ¨ªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ç¸¦ä¸­æ¨ªæŒ‡å®šã®ä¸€éƒ¨ã«ã®ã¿å‚ç‚¹æŒ‡å®š
			grep -E -o -n '\^[^ã€Š]+ã€Šã€Š[^ã€‹]+ã€‹ã€‹\^|\^ã€Šã€Š[^ã€‹]+ã€‹ã€‹[^ã€‹]+\^' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ç¸¦ä¸­æ¨ªã®ä¸€éƒ¨ã«ã ã‘å‚ç‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ãƒ«ãƒ“æŒ‡å®šå…¨ä½“ã«å›è»¢æŒ‡å®š
			grep -E -o -n '\[\^ï½œ[^ã€Š]+ã€Š[^ã€‹]+ã€‹\^\]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ãƒ«ãƒ“æŒ‡å®šã®å…¨ä½“ã«å›è»¢ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸é©åˆ‡ãªæŒ‡å®šã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# å¼·åˆ¶åˆå­—ã®æŒ‡å®šãŒ2æ–‡å­—ã§ã¯ãªã„
			# 1æ–‡å­—ã‹ã€3æ–‡å­—ä»¥ä¸Šã¯é§„ç›®
			grep -E -o -n '\[l\[[^\]\]r\]|\[l\[[^\]{3}\]r\]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§å¼·åˆ¶åˆå­—ã«ã¯2æ–‡å­—ã ã‘ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ã‚¢ã¸æ¿ç‚¹ã«å›è»¢æŒ‡å®š
			grep -E -o -n '\[\^.ã‚›\^\]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§å¼·åˆ¶æ¿ç‚¹ã«å›è»¢ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ãƒ«ãƒ“æ–‡å­—ã«ç‰¹æ®ŠæŒ‡å®š
			## ãƒ«ãƒ“æ–‡å­—ã«ãƒ«ãƒ“
			grep -E -o -n 'ï½œ[^ã€Š]+ã€Š[^ã€‹]*ï½œ[^ã€‹]*ã€‹' "${tgtFile}" > "${destFile}"
			## ãƒ«ãƒ“æ–‡å­—ã«å¤ªå­—
			grep -E -o -n 'ï½œ[^ã€Š]+ã€Š[^ã€Šã€‹]*ã€Šã€Š[^ã€‹]+ã€‹ã€‹[^ã€‹]*ã€‹' "${tgtFile}" >> "${destFile}"
			## ãƒ«ãƒ“æ–‡å­—ã«å›è»¢
			grep -E -o -n 'ï½œ[^ã€Š]+ã€Š[^\[ã€‹]*\[\^\[^\^]\^\][^ã€‹]*ã€‹' "${tgtFile}" >> "${destFile}"
			## ãƒ«ãƒ“æ–‡å­—ã«åˆå­—
			grep -E -o -n 'ï½œ[^ã€Š]+ã€Š[^[ã€‹]*[l[[^]]{2}]r][^ã€‹]*ã€‹' "${tgtFile}" >> "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã§ãƒ«ãƒ“æ–‡å­—ã«ä¿®é£¾ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›ã¯éå¯¾å¿œã§ã™ã€‚å¤‰æ›ã¯å®Ÿæ–½ã—ã¾ã™ãŒçµæœã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚' 
			fi
			# ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹(æ”¹è¡Œç›´å‰ã®ã‚¹ãƒšãƒ¼ã‚¹ã€é–‰ã˜æ‹¬å¼§ç›´å‰ã®ã‚¹ãƒšãƒ¼ã‚¹)
			grep -E -o -n '[ ã€€]$|[ ã€€]([ã€ã€ï¼‰ã€Ÿ])|^(Â§+)[ ã€€]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹(æ”¹è¡Œç›´å‰ã®ã‚¹ãƒšãƒ¼ã‚¹ã€é–‰ã˜æ‹¬å¼§ç›´å‰ã®ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¨˜å·ç›´å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹)ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚'
				echo 'å†…éƒ¨çš„ã«é™¤å»ã—ã¦å¤‰æ›ã‚’å®Ÿæ–½ã—ã¾ã™ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“ãŒã€ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€ã§ã™ï¼‰ã€‚'
			fi
			#çµ„ç‰ˆæ™‚ã«ç½®æ›ã•ã‚Œã‚‹è¨˜å·é¡
			##è¡¨è¨˜ã‚†ã‚Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹è¨˜å·ã®çµ±ä¸€
			grep -E -o -n '[â™¡â™¥â˜†â–¡â™«â™¬]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«å«ã¾ã‚Œã‚‹è¨˜å·ã¯å¤‰æ›å¾Œã€åˆ¥ã®è¨˜å·ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“ï¼‰'
			fi
			##çµ„ç‰ˆæ™‚ã«ç½®æ›ã•ã‚Œã‚‹é€£ç¶šã€Œâ€•ã€
			grep -E -o -n 'â€•{2,}' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«å«ã¾ã‚Œã‚‹ã€é€£ç¶šã™ã‚‹ã€Œâ€•ã€ã¯ã€å€ã‚µã‚¤ã‚ºã®ä¸€ã¤ã®ã€Œâ€•ã€ã¸å¤‰æ›ã•ã‚Œã¾ã™(å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“)'
			fi
			##ï¼ï¼Ÿã®ãƒšã‚¢
			grep -E -o -n 'ï¼ï¼|ï¼ï¼Ÿ|ï¼Ÿï¼|ï¼Ÿï¼Ÿ' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«å«ã¾ã‚Œã‚‹ã€ï¼!ã€ï¼ï¼Ÿãªã©ã®ãƒšã‚¢ã¯å¤‰æ›å¾Œã€ï¼‘æ–‡å­—å¹…ã«åã¾ã‚‹ã‚ˆã†ã«åŠè§’ã®ãƒšã‚¢ã«å¤‰æ›ã•ã‚Œã¾ã™(å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“)'
			fi
			grep -E -o -n '^(Â§+)[ ã€€]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«å«ã¾ã‚Œã‚‹ã€ï¼!ã€ï¼ï¼Ÿãªã©ã®ãƒšã‚¢ã¯å¤‰æ›å¾Œã€ï¼‘æ–‡å­—å¹…ã«åã¾ã‚‹ã‚ˆã†ã«åŠè§’ã®ãƒšã‚¢ã«å¤‰æ›ã•ã‚Œã¾ã™(å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“)'
			fi
			grep -E -o -n '^$' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘ã«å«ã¾ã‚Œã‚‹ç©ºè¡Œã¯ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜è¿°ã«é–¢ã‚ã‚‰ãšã€å¤‰æ›è¦å‰‡ã«å‰‡ã£ã¦å‰Šé™¤ã‚ã‚‹ã„ã¯è¿½åŠ ã•ã‚Œã¾ã™(å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“)'
			fi
			# è¨˜å·é¡ã®ç›´å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„
			grep -E -o -n '[!\?ï¼ï¼Ÿâ¤ğŸ’ğŸ’•â™ªâ˜†â˜…ğŸ’¢][^ã€€ã€ã€ï¼‰!\?ï¼ï¼Ÿâ¤ğŸ’ğŸ’•â™ªâ˜†â˜…ğŸ’¢]' "${tgtFile}" > "${destFile}"
			if [[ -s "${destFile}" ]]; then 
				cat "${destFile}"
				echo 'ğŸ¤” â†‘è¨˜å·é¡ã®ç›´å¾Œã«ã€ãã‚ŒãŒé€£ç¶šã™ã‚‹ã‹è¡Œæœ«ãƒ»æ‹¬å¼§å†…æœ«å°¾ã§ãªã„é™ã‚Šã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒ¿å…¥ã—ã¾ã™(å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿®æ­£ã—ã¾ã›ã‚“)'
			fi

		}

		: "å¤‰æ›å®Ÿæ–½" && {
			#AWKã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®šç¾©ã•ã‚ŒãŸAWK_CODEã‚’ä½¿ç”¨ï¼‰
			gawk "$AWK_CODE" "${tgtFile}" > "${destFile}"
		}

		echo "âœ¨ "${destFile}"ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ[htmlåŒ–]"

	}

elif [[ "${convMode}" = '-t' ]]; then
  ## htmlâ†’txt ############################################################################################
	: "htmlâ†’txtå¤‰æ›å‡¦ç†" && {

		: "AWKã‚³ãƒ¼ãƒ‰å®šç¾©" && {
			# littlebug.awkã®å†…å®¹ã‚’ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å®šç¾©
			read -r -d '' AWK_CODE <<- 'AWK_EOF'
			#!/usr/bin/awk -f

			# ãƒ«ãƒ“ã‚¿ã‚°ã‚’å…ƒã®çŸ­ç¸®ã‚¿ã‚°ã«æˆ»ã™é–¢æ•°
			# <ruby class="ltlbg_ruby-*" data-*="ãƒ«ãƒ“">è¦ªæ–‡å­—<rt>ãƒ«ãƒ“</rt></ruby> â†’ ï½œè¦ªæ–‡å­—ã€Šãƒ«ãƒ“ã€‹
			function strip_ruby_tags(text) {
				new_text = ""
				# ãƒ«ãƒ“ã‚¿ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãªããªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
				while (match(text, /<ruby class="ltlbg_ruby-[^"]*" data-ltlbg_ruby-[^"]*="([^"]+)">([^<]+)<rt>[^<]+<\/rt><\/ruby>/, m)) {
					new_text = new_text substr(text, 1, RSTART - 1)
					ruby = m[1]
					parent = m[2]
					new_text = new_text "ï½œ" parent "ã€Š" ruby "ã€‹"
					text = substr(text, RSTART + RLENGTH)
				}
				new_text = new_text text
				return new_text
			}

			# åœç‚¹ï¼ˆå‚ç‚¹ï¼‰ã‚¿ã‚°ã‚’å…ƒã®çŸ­ç¸®ã‚¿ã‚°ã«æˆ»ã™é–¢æ•°
			# <ruby class="emphasis">æ–‡<rt>ï¹…</rt></ruby>... â†’ ã€Šã€Šæ–‡...ã€‹ã€‹
			function strip_emphasis_tags(text) {
				new_text = ""
				# é€£ç¶šã™ã‚‹åœç‚¹ã‚¿ã‚°ã‚’æ¤œå‡ºã—ã¦ã¾ã¨ã‚ã¦å‡¦ç†
				while (match(text, /<ruby class="emphasis">([^<])<rt>ï¹…<\/rt><\/ruby>/, m)) {
					new_text = new_text substr(text, 1, RSTART - 1)
					
					# æœ€åˆã®æ–‡å­—ã‚’å–å¾—
					parent_chars = m[1]
					matched_len = RLENGTH
					outer_rstart = RSTART
					remaining = substr(text, outer_rstart + matched_len)
					
					# é€£ç¶šã™ã‚‹åœç‚¹ã‚¿ã‚°ã‚’å‡¦ç†
					while (match(remaining, /^<ruby class="emphasis">([^<])<rt>ï¹…<\/rt><\/ruby>/, m2)) {
						parent_chars = parent_chars m2[1]
						matched_len = matched_len + RLENGTH
						remaining = substr(remaining, RLENGTH + 1)
					}
					
					new_text = new_text "ã€Šã€Š" parent_chars "ã€‹ã€‹"
					text = substr(text, outer_rstart + matched_len)
				}
				new_text = new_text text
				return new_text
			}

			BEGIN {
				output_buffer = ""
				in_content = 0
				is_sukebe_section = 0
			}

			{
				line = $0
				
				# HTMLãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—
				if (line ~ /^<html>/ || line ~ /^<\/html>/ || 
					line ~ /^  <head>/ || line ~ /^  <\/head>/ ||
					line ~ /^    <link / || line ~ /^    <!--<link / ||
					line ~ /^  <body>/ || line ~ /^<\/body>/ ||
					line ~ /^<div class="ltlbg_container">/ || line ~ /^<\/div><!--ltlbg_container-->/ ||
					line ~ /^<!--æ–‡ç« å†…å®¹ã“ã“ã‹ã‚‰-->/ || line ~ /^<!--æ–‡ç« å†…å®¹ã“ã“ã¾ã§-->/) {
					next
				}
				
				# sectionã‚¿ã‚°ã‚’å‡¦ç†
				if (match(line, /<section class="([^"]+)">/, m)) {
					if (m[1] == "ltlbg_section_sukebe") {
						is_sukebe_section = 1
					} else {
						is_sukebe_section = 0
					}
					next
				}
				if (line ~ /^<\/section>/) {
					is_sukebe_section = 0
					next
				}
				
				# divã‚¿ã‚°ã‚’é™¤å»
				if (line ~ /^  <div class="ltlng_/ || line ~ /^  <\/div>/) {
					next
				}
				
				# å…ˆé ­ã®ASCIIç©ºç™½ã¨ã‚¿ãƒ–ã‚’é™¤å»ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼‰
				# å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã¯æ®‹ã™
				line = gensub(/^[ \t]+/, "", "g", line)
				
				# ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚¿ã‚°ã‚’å‡¦ç†
				# <h2 class="ltlbg_section_name">Â§å†…å®¹</h2> â†’ Â§å†…å®¹ or Â§â¤å†…å®¹
				if (match(line, /<h2 class="ltlbg_section_name">([^<]+)<\/h2>/, m)) {
					line = m[1]
					if (is_sukebe_section == 1) {
						sub(/^Â§/, "Â§â¤", line)
					}
				}
				
				# ãƒ«ãƒ“ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™ï¼ˆå†…å´ã®ã‚¿ã‚°ã‚’å…ˆã«å‡¦ç†ï¼‰
				line = strip_ruby_tags(line)
				
				# åœç‚¹ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™ï¼ˆå†…å´ã®ã‚¿ã‚°ã‚’å…ˆã«å‡¦ç†ï¼‰
				line = strip_emphasis_tags(line)
				
				# ç‰¹æ®Šè¨˜å·ã®spanã‚¿ã‚°ã‚’é™¤å»
				# <span class="ltlbg_wdfix">å†…å®¹</span> â†’ å†…å®¹
				line = gensub(/<span class="ltlbg_wdfix">([^<]*)<\/span>/, "\\1", "g", line)
								
				# å…¨è§’ãƒ€ãƒƒã‚·ãƒ¥ã®spanã‚¿ã‚°ã‚’é™¤å»
				line = gensub(/<span class="ltlbg_wSize">â€•<\/span>/, "â€•", "g", line)
				
				# å¤ªå­—ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				# <span class="ltlbg_bold">å†…å®¹</span> â†’ **å†…å®¹**
				line = gensub(/<span class="ltlbg_bold">([^<]*)<\/span>/, "**\\1**", "g", line)
				
				# å›è»¢ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				# <span class="ltlbg_rotate">å†…å®¹</span> â†’ [^å†…å®¹^]
				line = gensub(/<span class="ltlbg_rotate">([^<]*)<\/span>/, "[^\\1^]", "g", line)
				
				# ç¸¦ä¸­æ¨ªã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				# <span class="ltlbg_tcy">å†…å®¹</span> â†’ ^å†…å®¹^
				line = gensub(/<span class="ltlbg_tcy">([^<]*)<\/span>/, "^\\1^", "g", line)
				
				# å¼·åˆ¶åˆå­—ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				# <span class="ltlbg_forcedGouji1/2">å†…å®¹</span> â†’ [l[å†…å®¹]r]
				line = gensub(/<span class="ltlbg_forcedGouji1\/2">([^<]*)<\/span>/, "[l[\\1]r]", "g", line)
				
				# ã‚»ãƒŸã‚³ãƒ­ãƒ³ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_semicolon">ï¼›<\/span>/, "ï¼›", "g", line)
				
				# ã‚³ãƒ­ãƒ³ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_colon">ï¼š<\/span>/, "ï¼š", "g", line)
				
				# ã‚¹ã‚±ãƒ™æ¿éŸ³ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_dakuten"><\/span>/, "ã‚›", "g", line)
				
				# ã‚­ãƒã‚¬ã‚¤åŠæ¿éŸ³ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_handakuten"><\/span>/, "ã‚œ", "g", line)
				
				# æ”¹ãƒšãƒ¼ã‚¸ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
			    line = gensub(/<div class="ltlbg_newpage"><\/div><!--ltlbg_newpage-->/, "[newpage]", "g", line)
				
				# æ°´å¹³ç·šã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_hr"><\/span>/, "---", "g", line)
				
				# è¸Šã‚Šå­—ã‚¿ã‚°ã‚’å…ƒã«æˆ»ã™
				line = gensub(/<span class="ltlbg_odori1"><\/span><span class="ltlbg_odori2"><\/span>/, "ï¼ï¼¼", "g", line)
				
				# HTMLæ–‡å­—å‚ç…§ã‚’å…ƒã«æˆ»ã™
				line = gensub(/&amp;/, "\\&", "g", line)
				line = gensub(/&lt;/, "<", "g", line)
				line = gensub(/&gt;/, ">", "g", line)
				line = gensub(/&#39;/, "'", "g", line)
				line = gensub(/&quot;/, "\"", "g", line)
				line = gensub(/&#047;/, "/", "g", line)
				line = gensub(/&#092;/, "\\\\", "g", line)

				# å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã®spanã‚¿ã‚°ã‚’é™¤å»
				line = gensub(/<span class="ltlbg_wSp"><\/span>/, "ã€€", "g", line)
				# åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã®spanã‚¿ã‚°ã‚’é™¤å»
				line = gensub(/<span class="ltlbg_sSp"><\/span>/, " ", "g", line)
				
				# æ®µè½ã‚¿ã‚°ã‚’å‡¦ç†ï¼ˆå†…éƒ¨ã‚¿ã‚°ã®é™¤å»å¾Œã«å‡¦ç†ï¼‰
				# <p class="ltlbg_bracket" data-p_header="ã€Œ" data-p_footer="ã€">å†…å®¹</p><!--bracket--> â†’ ã€Œå†…å®¹ã€
				line = gensub(/<p class="ltlbg_bracket"[^>]*data-p_header="([^"]*)"[^>]*data-p_footer="([^"]*)"[^>]*>(.*)<\/p><!--bracket-->/, "\\1\\3\\2", "g", line)
				
				# é–‰ã˜æ‹¬å¼§ã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
				line = gensub(/<p class="ltlbg_bracket"[^>]*data-p_footer="([^"]*)"[^>]*>(.*)<\/p><!--bracket-->/, "\\2\\1", "g", line)
				
				# åœ°ã®æ–‡ã‚¿ã‚°ã‚’å‡¦ç†
				# <p class="ltlbg_desciption" data-p_header="ã€€">å†…å®¹</p><!--descript--> â†’ ã€€å†…å®¹
				line = gensub(/<p class="ltlbg_desciption"[^>]*data-p_header="([^"]*)"[^>]*>(.*)<\/p><!--descript-->/, "\\1\\2", "g", line)
				
				# ç©ºè¡Œã§ãªã‘ã‚Œã°å‡ºåŠ›
				if (line != "") {
					print line
				}
			}
			AWK_EOF
		}


		destFile="${tgtFile/'.html'/'_stripped.txt'}" #å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã™ã‚‹
		printf '' > "${destFile}"


		: "å¤‰æ›å®Ÿæ–½" && {
			#AWKã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®šç¾©ã•ã‚ŒãŸAWK_CODEã‚’ä½¿ç”¨ï¼‰
			gawk "$AWK_CODE" "${tgtFile}" > "${destFile}"
		}

		echo "âœ¨ "${destFile}"ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ[txtã‚‚ã©ã—]"
	}

fi

exit 0
